namespace = ek_sa_krosis

ek_sa_krosis.0001 = {
	type = empty
	hidden = yes

	immediate = {
		title:c_shearpoint = {
			holder = {
				create_story = story_cycle_krosis
				trigger_event = ek_sa_krosis.0002
			}
			any_liege_or_above = {
				trigger_event = ek_sa_krosis.0002
			}
		}
		set_global_variable = ek_sa_start_krosis
		ek_sa_create_dragon_priest_effect = {
			PRIEST = krosis
			LOCATION = c_shearpoint
		}
		title:d_krosis = {
			holder = {
				save_scope_as = dragon_priest_krosis
			}
		}
		set_global_variable = {
			name = ek_sa_krosis_progress
			value = 0
		}
	}
}

ek_sa_krosis.0002 = {
	type = character_event
	title = ek_sa_krosis.0002.t
	desc = ek_sa_krosis.0002.desc

	theme = faith

	left_portrait = {
		character = root
		animation = worry
	}

	option = {
		flavor = ek_sa_krosis.0002.a.flavor
		name = ek_sa_krosis.0002.a
	}

}

ek_sa_krosis.0003 = {
	type = character_event
	hidden = yes

	immediate = {
		title:d_krosis = {
			holder = {
				save_scope_as = dragon_priest_krosis
			}
		}
	}

	option = {
		ai_chance = {
			base = 50
		}
		change_global_variable = {
			name = ek_sa_krosis_progress
			add = 1
		}
	}

	option = {
		ai_chance = {
			base = 30
		}
	}

	option = {
		ai_chance = {
			base = 10
		}
		change_global_variable = {
			name = ek_sa_krosis_progress
			add = 2
		}
	}

	option = {
		ai_chance = {
			base = 10
		}
		change_global_variable = {
			name = ek_sa_krosis_progress
			subtract = 1
		}
	}

}

ek_sa_krosis.0004 = {
	type = character_event
	hidden = yes

	immediate = {
		title:d_krosis = {
			holder = {
				save_scope_as = krosis
			}
		}
		title:c_shearpoint = {
			holder = {
				top_liege = {
					save_scope_as = war_target
				}
			}
		}
	}

	option = {
		scope:krosis = {
			add_pressed_claim = title:c_shearpoint
			start_war = {
				cb = claim_cb
				target = scope:war_target
				target_title = title:c_shearpoint
			}
			spawn_army = {
				men_at_arms = {
					stacks = global_var:ek_sa_krosis_progress
					type = risen_dead
				}
				location = title:c_shearpoint.title_province
				name = "risen_dead"
				inheritable = no
			}
			if = {
				limit = {
					global_var:ek_sa_krosis_progress > 20
				}
				change_global_variable = {
					name = ek_sa_krosis_progress
					substract = 20
				}
				get_dragon_name = yes
				spawn_army = {
					men_at_arms = {
						type = dragons
						stacks = global_var:ek_sa_krosis_progress
					}
					inheritable = no
					location = title:c_shearpoint.title_province
					save_scope_as = summoned_dragon
					name = ek_religious_army
				}
			}
		}
	}
}

ek_sa_krosis.0005 = {
	type = character_event
	hidden = yes
	# TODO - create krosis defeated event
}

ek_sa_krosis.0006 = {
	type = character_event
	title = ek_sa_krosis.0006.t
	desc = ek_sa_krosis.0006.desc
	theme = faith
	immediate = {
		root = {
			save_scope_as = funder
		}
		ordered_courtier = {
			ordered_knight = {
				limit = {
					is_imprisoned = no
				}
				order_by = prowess
				position = 1
				save_scope_as = volunteer_knight
			}
		}
		if = {
			limit = {
				exists = cp:councillor_marshal
			}
			cp:councillor_marshal = {
				save_scope_as = marshal
			}
		}
		title:d_krosis = {
			holder = {
				save_scope_as = krosis
				save_scope_as = sc_defender
			}
		}
		save_scope_value_as = {
			name = fatality
			value = flag:always
		}
		save_scope_value_as = {
			name = locale
			value = flag:terrain_scope
		}
	}

	left_portrait = {
		character = root
		animation = aggresive_axe
	}

	right_portrait = {
		character = scope:krosis
		animation = aggresive_mace
	}

	lower_left_portrait = {
		trigger = {
			exists = scope:marshal
		}
		character = scope:marshal
	}

	lower_right_portrait = {
		character = scope:volunteer_knight
	}

	option = {
		name = ek_sa_krosis.0006.a
		highlight_portrait = root
		configure_start_single_combat_effect = {
			SC_INITIATOR = root
			SC_ATTACKER = root
			SC_DEFENDER = scope:krosis
			FATALITY = no
			FIXED = no
			LOCALE = terrain_scope
			OUTPUT_EVENT = ek_sa_krosis.0007
			INVALIDATION_EVENT = ek_sa_krosis.0007	#In a real event, this would obviously be a different even to the output.
		}
	}

	option = {
		name = ek_sa_krosis.0006.b
		trigger = {
			exists = scope:marshal
		}
		scope:marshal = {
			save_scope_as = sc_attacker
		}
		highlight_portrait = scope:marshal
		configure_start_single_combat_effect = {
			SC_INITIATOR = root
			SC_ATTACKER = scope:marshal
			SC_DEFENDER = scope:krosis
			FATALITY = no
			FIXED = no
			LOCALE = terrain_scope
			OUTPUT_EVENT = ek_sa_krosis.0007
			INVALIDATION_EVENT = ek_sa_krosis.0007	#In a real event, this would obviously be a different even to the output.
		}
	}

	option = {
		name = ek_sa_krosis.0006.c
		trigger = {
			exists = scope:volunteer_knight
		}
		scope:volunteer_knight = {
			save_scope_as = sc_attacker
		}
		highlight_portrait = scope:volunteer_knight
		configure_start_single_combat_effect = {
			SC_INITIATOR = root
			SC_ATTACKER = scope:volunteer_knight
			SC_DEFENDER = scope:krosis
			FATALITY = no
			FIXED = no
			LOCALE = terrain_scope
			OUTPUT_EVENT = ek_sa_krosis.0007
			INVALIDATION_EVENT = ek_sa_krosis.0007	#In a real event, this would obviously be a different even to the output.
		}
	}

	option = {
		name = ek_sa_krosis.0006.d
		add_gold = 250
	}
}

ek_sa_krosis.0007 = {
	type = character_event
	hidden = yes

	immediate = {
		if = {
			limit = {
				scope:sc_loser = scope:krosis
			}
			title:d_krosis = {
				holder = {
					every_character_artifact = {
						set_owner = scope:funder
					}
				}
			}
			destroy_title = title:d_krosis
			scope:krosis = {
				death = {
					killer = scope:victor
					death_reason = death_duel
				}
			}
			set_global_variable = ek_sa_krosis_slain
			scope:funder = {
				trigger_event = ek_sa_krosis.0008
			}
		}
		if = {
			limit = {
				scope:sc_victor = scope:krosis
			}
			scope:sc_loser = {
				death = {
					killer = scope:krosis
					death_reason = death_duel
				}
			}
			if = {
				limit = {
					NOT = {
						scope:loser = scope:funder
					}
				}
				scope:funder = {
					trigger_event = ek_sa_krosis.0009
				}
			}
		}
	}
}

ek_sa_krosis.0008 = {
	type = character_event
	theme = faith

	desc = ek_sa_krosis.0008.desc
	title = ek_sa_krosis.0008.t

	immediate = {
		set_global_variable = ek_sa_krosis_slain
	}

	left_portrait = {
		character = scope:attacker
		animation = victorious
	}

	option = {
		name = ek_sa_krosis.0008.a
	}
}

ek_sa_krosis.0009 = {
	type = character_event
	theme = faith

	desc = ek_sa_krosis.0009.desc
	title = ek_sa_krosis.0009.t

	left_portrait = {
		character = scope:sc_loser
		animation = fear
	}

	right_portrait = {
		character = scope:funder
		animation = worry
	}

	option = {
		name = ek_sa_krosis.0009.a
	}
}